<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Game By Phaser</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">

        @import url('https://fonts.googleapis.com/css2?family=Aldrich&display=swap');

        body {
            margin: 0;
            background: #333;
        }

        canvas{
            position: relative;
            margin: 0 auto;
            display: inherit;
            width: auto;
            margin-top: calc(50vh - 300px);
        }

        @media (max-width: 768px) {
            canvas{
                width: 100%;
                margin-top: auto;
            }
        }

    </style>
</head>
<body>
    
    <script>
        var config = {
            type: Phaser.AUTO,
            width: 1000,
            height: 600,
            physics: {
            default: 'arcade',
                arcade: {
                    gravity: { y: 1000 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        
        var player;
        var platforms;
        var cursors;
        var coins;

        var score = 0;
        var scoreText;

        var game = new Phaser.Game(config);

        function preload ()
        {
            //載入圖片
            this.load.image('bg', 'assets/bg.png');
            this.load.image('top', 'assets/top.png');
            this.load.image('left', 'assets/left.png');
            this.load.image('bottom', 'assets/bottom.png');
            this.load.image('right', 'assets/right.png');
            this.load.image('ground', 'assets/ground.png');

            //載入人物 
            this.load.spritesheet('chibi', 
                'assets/player.png',
                { frameWidth: 60, frameHeight: 50 }
            );

            //載入硬幣 
            this.load.spritesheet('coin', 
                'assets/coin.png',
                { frameWidth: 40, frameHeight: 40 }
            );

        }

        function create ()
        {
            this.add.image(500, 300, 'bg');

            platforms = this.physics.add.staticGroup(); //設定靜態物件 group ex: 牆壁
            platforms.create(500, 50, 'top');
            platforms.create(950, 300, 'right');
            platforms.create(500, 550, 'bottom'); 
            platforms.create(50, 300, 'left');

            platforms.create(500 + Phaser.Math.FloatBetween(-30,30), 130+68, 'ground');
            platforms.create(190, 130+68+68+34, 'ground');
            platforms.create(810, 130+68+68+34, 'ground');
            platforms.create(500 + Phaser.Math.FloatBetween(-30,30), 130+68+68+68+68, 'ground');

            
            //***角色**********************************************************************************
            //設定角色
            player = this.physics.add.sprite(200, 400, 'chibi').setScale(1.2);
            player.setBounce(0.2); //反弹（bounce）值
            player.setCollideWorldBounds(true); //世界边界（bound）的碰撞

            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('chibi', { start: 0, end: 1 }), //使用0, 1帧
                frameRate: 10, //每秒10帧
                repeat: -1 //告诉动画要循环播放
            });

            this.anims.create({
                key: 'turn',
                frames: [ { key: 'chibi', frame: 2 } ],
                frameRate: 20
            });

            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('chibi', { start: 3, end: 4 }),
                frameRate: 5,
                repeat: -1
            });
            //***角色 End**********************************************************************************



            
            //***設定金幣**********************************************************************************
            //產生10個金幣
            coins = this.physics.add.group({
                key: 'coin',
                repeat: 9,
                setXY: { x: 150, y: 0, stepX: 80 },
            });
            //設定金幣動畫 0~6 依序旋轉
            this.anims.create({
                key: 'coin_run',
                frames: this.anims.generateFrameNumbers('coin', { start: 0, end: 6 }),
                frameRate: 5,
                repeat: -1
            });
            //設定金幣彈跳且跑動畫
            coins.children.iterate(function (child) {
                child.setBounceY(Phaser.Math.FloatBetween(0.2, 0.8));
                child.anims.play('coin_run');
            });
            //判斷 人物與金幣碰撞事件
            this.physics.add.overlap(player, coins, collectStar, null, this);
            //***設定金幣 End**********************************************************************************

            //添加事件监听器
            cursors = this.input.keyboard.createCursorKeys();
             
            
            // 碰撞器（Collider）
            this.physics.add.collider(player, platforms); 
            this.physics.add.collider(coins, platforms);

            //分數
            scoreText = this.add.text(110, 110, 'Coin : 0', { fontSize: '24px', fill: '#e2bc13' ,fontFamily: "'Aldrich', sans-serif" });

        }

        function update ()
        {
            if (cursors.left.isDown)
            {
                player.setVelocityX(-300);

                player.anims.play('left', true);
            }
            else if (cursors.right.isDown)
            {
                player.setVelocityX(300);

                player.anims.play('right', true);
            }
            else
            {
                player.setVelocityX(0);

                player.anims.play('turn');
            }

            if ((cursors.up.isDown || cursors.space.isDown) && player.body.touching.down)
            {
                player.setVelocityY(-550);
            }
            var pointer = this.input.activePointer;
            if (pointer.isDown) {
                var touchX = pointer.x;
                var touchY = pointer.y;
                
                
                if(player.x > touchX & player.y > touchY  & touchY < 500){
                    player.setVelocityX(-300);
                    player.anims.play('left', true);
                    
                    if(player.body.touching.down){
                        player.setVelocityY(-550);
                    }
                }
                if(player.x < touchX & player.y > touchY & touchY < 500){
                    player.setVelocityX(300);
                    player.anims.play('right', true);
                    
                    if(player.body.touching.down){
                        player.setVelocityY(-550);
                    }
                }

                if(player.x > touchX & player.y < touchY){
                    player.setVelocityX(-300);
                    player.anims.play('left', true);
                }
                if(player.x < touchX & player.y < touchY){
                    player.setVelocityX(300);
                    player.anims.play('right', true);
                }

            }

            // coins.anims.play('coin_anims');
        }

        function collectStar (player, star)
        {
            star.disableBody(true, true);

            score += 1;
            scoreText.setText('Coin : ' + score);

            if (coins.countActive(true) === 0)
            {
                coins.children.iterate(function (child) {
                    child.enableBody(true, child.x, 0, true, true);
                });
            }
        }
    </script>
</body>
</html>